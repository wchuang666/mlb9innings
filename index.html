<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>MLB 9局職棒 紀錄 (最終修復版)</title>
  
  <!-- iOS PWA 設定 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MLB紀錄">

  <!-- 樣式與工具庫 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    window.Firebase = {
      initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
      getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy
    };
    window.dispatchEvent(new Event('firebase-ready'));
  </script>

  <style>
    /* 基礎樣式 */
    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      background-color: #020617; /* Slate 950 */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      overflow: hidden;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    input, button, select, textarea { outline: none; -webkit-tap-highlight-color: transparent; }
    input[type="date"] { color-scheme: dark; }
    
    /* 動畫 */
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  </style>
</head>
<body>
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    
    // --- [關鍵修復] Icon 元件 ---
    // 使用 useRef 建立一個獨立容器，讓 Lucide 在裡面自己玩，
    // 這樣 React 就不會因為找不到被換掉的 DOM 而報錯 (NotFoundError)。
    const Icon = ({ name, size = 20, className = "" }) => {
      const containerRef = useRef(null);

      useEffect(() => {
        if (!window.lucide || !containerRef.current) return;

        // 1. 清空容器，確保乾淨
        containerRef.current.innerHTML = '';
        
        // 2. 建立一個臨時的標籤
        const i = document.createElement('i');
        i.setAttribute('data-lucide', name);
        
        // 3. 放入容器
        containerRef.current.appendChild(i);

        // 4. 呼叫 Lucide 轉換 (只轉換這個容器內的)
        window.lucide.createIcons({
          root: containerRef.current,
          attrs: {
            width: size,
            height: size,
            class: className
          }
        });
      }, [name, size, className]);

      return <span ref={containerRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></span>;
    };

    // --- App 主程式 ---
    const App = () => {
      // 系統狀態
      const [firebaseReady, setFirebaseReady] = useState(false);
      const [configError, setConfigError] = useState(false); 
      const [user, setUser] = useState(null);
      const [db, setDb] = useState(null);
      
      // 設定畫面輸入
      const [configInput, setConfigInput] = useState('');
      const [parseError, setParseError] = useState('');

      // App 顯示狀態
      const [currentView, setCurrentView] = useState('accounts');
      const [selectedAccount, setSelectedAccount] = useState(null);
      const [showSettings, setShowSettings] = useState(false);
      
      // 資料狀態
      const [accounts, setAccounts] = useState([]);
      const [accountCards, setAccountCards] = useState([]);

      // Modal 表單
      const [isAccountModalOpen, setIsAccountModalOpen] = useState(false);
      const [isCardModalOpen, setIsCardModalOpen] = useState(false);
      
      // 輸入值
      const [newAccountName, setNewAccountName] = useState('');
      const [newAccountSince, setNewAccountSince] = useState('');
      const [newCardName, setNewCardName] = useState('');
      const [newCardType, setNewCardType] = useState('signature');
      const [newCardDate, setNewCardDate] = useState(new Date().toISOString().split('T')[0]);

      // 卡片類型定義
      const CARD_TYPES = [
        { id: 'signature', label: '簽名 (Signature)', color: 'text-green-400', border: 'border-green-500/50', bg: 'bg-green-500/10', icon: 'user' },
        { id: 'legend', label: '傳說 (Legend)', color: 'text-purple-400', border: 'border-purple-500/50', bg: 'bg-purple-500/10', icon: 'crown' },
        { id: 'supreme', label: '卓越 (Supreme)', color: 'text-red-400', border: 'border-red-500/50', bg: 'bg-red-500/10', icon: 'zap' },
        { id: 'prime', label: '全盛 (Prime)', color: 'text-blue-400', border: 'border-blue-500/30', bg: 'bg-blue-500/10', icon: 'star' },
        { id: 'vintage', label: '經典 (Vintage)', color: 'text-amber-600', border: 'border-amber-600/30', bg: 'bg-amber-600/10', icon: 'activity' },
        { id: 'normal', label: '一般/其他', color: 'text-gray-400', border: 'border-gray-600/30', bg: 'bg-gray-600/10', icon: 'user' },
      ];

      // --- 1. 初始化 Firebase ---
      useEffect(() => {
        const init = async () => {
          if (!window.Firebase) return;
          
          let finalConfig = null;

          // 讀取設定
          const storedConfig = localStorage.getItem('mlb_firebase_config_v2');
          if (storedConfig) {
            try {
              finalConfig = JSON.parse(storedConfig);
            } catch (e) {
              console.error("Stored config invalid");
            }
          }

          // 沒有設定則顯示輸入畫面
          if (!finalConfig) {
            setConfigError(true);
            return;
          }

          // 連線
          try {
            let app;
            try {
              app = window.Firebase.initializeApp(finalConfig);
            } catch (e) {
               if (e.code !== 'app/duplicate-app') throw e;
            }
            
            const auth = window.Firebase.getAuth(); 
            const firestore = window.Firebase.getFirestore();
            setDb(firestore);

            await window.Firebase.signInAnonymously(auth);

            window.Firebase.onAuthStateChanged(auth, (u) => {
              if (u) {
                setUser(u);
                setFirebaseReady(true);
                setConfigError(false);
              }
            });
          } catch (e) {
            console.error("Firebase Init Error:", e);
            localStorage.removeItem('mlb_firebase_config_v2');
            setConfigError(true);
            setParseError("連線失敗，您的金鑰可能無效，請重新輸入。");
          }
        };

        if (window.Firebase) init();
        else window.addEventListener('firebase-ready', init);
        return () => window.removeEventListener('firebase-ready', init);
      }, []);

      // --- 功能函式 ---
      const handleSaveConfig = () => {
        try {
          let cleaned = configInput.trim();
          cleaned = cleaned.replace(/^(const|var|let|export\s+const)\s+\w+\s*=\s*/, '');
          cleaned = cleaned.replace(/;$/, '');
          const configObj = new Function('return ' + cleaned)();

          if (!configObj || !configObj.apiKey) throw new Error("格式不正確");

          localStorage.setItem('mlb_firebase_config_v2', JSON.stringify(configObj));
          window.location.reload();
        } catch (e) {
          setParseError("解析失敗，請確認複製完整的 { ... } 內容");
        }
      };

      const handleResetConfig = () => {
        if (confirm('確定重設連結？需要重新輸入金鑰。')) {
          localStorage.removeItem('mlb_firebase_config_v2');
          window.location.reload();
        }
      };

      // 讀取帳號
      useEffect(() => {
        if (!user || !db) return;
        const q = window.Firebase.query(window.Firebase.collection(db, 'artifacts', 'mlb_app', 'users', user.uid, 'mlb_accounts'));
        const unsubscribe = window.Firebase.onSnapshot(q, (snapshot) => {
          setAccounts(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        return () => unsubscribe();
      }, [user, db]);

      // 讀取卡片
      useEffect(() => {
        if (!user || !db || !selectedAccount) return;
        const cardsRef = window.Firebase.collection(db, 'artifacts', 'mlb_app', 'users', user.uid, 'mlb_accounts', selectedAccount.id, 'cards');
        const unsubscribe = window.Firebase.onSnapshot(cardsRef, (snapshot) => {
          const loaded = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
          loaded.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
          setAccountCards(loaded);
        });
        return () => unsubscribe();
      }, [user, db, selectedAccount]);

      const stats = useMemo(() => {
        const counts = { signature: 0, legend: 0, supreme: 0, total: 0 };
        accountCards.forEach(card => {
          counts.total++;
          if (card.type === 'signature') counts.signature++;
          if (card.type === 'legend') counts.legend++;
          if (card.type === 'supreme') counts.supreme++;
        });
        return counts;
      }, [accountCards]);

      const getCardTypeInfo = (typeId) => CARD_TYPES.find(t => t.id === typeId) || CARD_TYPES[5];

      const handleCreateAccount = async (e) => {
        e.preventDefault();
        if (!newAccountName) return;
        await window.Firebase.addDoc(window.Firebase.collection(db, 'artifacts', 'mlb_app', 'users', user.uid, 'mlb_accounts'), {
          name: newAccountName,
          since: newAccountSince || new Date().toISOString().split('T')[0],
          createdAt: window.Firebase.serverTimestamp()
        });
        setNewAccountName('');
        setIsAccountModalOpen(false);
      };

      const handleAddCard = async (e) => {
        e.preventDefault();
        if (!newCardName) return;
        const cardsRef = window.Firebase.collection(db, 'artifacts', 'mlb_app', 'users', user.uid, 'mlb_accounts', selectedAccount.id, 'cards');
        await window.Firebase.addDoc(cardsRef, {
          name: newCardName,
          type: newCardType,
          date: newCardDate,
          createdAt: window.Firebase.serverTimestamp()
        });
        setNewCardName('');
        setIsCardModalOpen(false);
      };

      const handleDeleteCard = async (cardId) => {
        if(!confirm('確定刪除？')) return;
        await window.Firebase.deleteDoc(window.Firebase.doc(db, 'artifacts', 'mlb_app', 'users', user.uid, 'mlb_accounts', selectedAccount.id, 'cards', cardId));
      };

      const handleDeleteAccount = async (e, accId) => {
        e.stopPropagation();
        if(!confirm('確定刪除此帳號？')) return;
        await window.Firebase.deleteDoc(window.Firebase.doc(db, 'artifacts', 'mlb_app', 'users', user.uid, 'mlb_accounts', accId));
      };

      // --- 渲染 ---

      if (configError) {
        return (
          <div className="h-screen w-full flex flex-col items-center justify-center p-6 bg-slate-950 text-white animate-fade-in">
            <div className="w-full max-w-md bg-slate-900 border border-slate-800 rounded-2xl p-6 shadow-2xl">
              <div className="flex flex-col items-center mb-6">
                <div className="bg-blue-500/10 p-3 rounded-full mb-3">
                  <Icon name="database" size={40} className="text-blue-500" />
                </div>
                <h2 className="text-xl font-bold">連結雲端資料庫</h2>
                <p className="text-slate-400 text-sm mt-2 text-center">請貼上 Firebase Config</p>
              </div>
              <div className="space-y-4">
                <textarea
                  className="w-full h-48 bg-slate-950 border border-slate-700 rounded-xl p-3 text-xs font-mono text-green-400 focus:border-blue-500 resize-none outline-none"
                  placeholder={'const firebaseConfig = {\n  apiKey: "AIzaSy...",\n  ...\n};'}
                  value={configInput}
                  onChange={(e) => setConfigInput(e.target.value)}
                />
                {parseError && <div className="text-red-400 text-xs p-2">{parseError}</div>}
                <button onClick={handleSaveConfig} className="w-full py-3 bg-blue-600 rounded-xl font-bold">開始使用</button>
              </div>
            </div>
          </div>
        );
      }

      if (!firebaseReady) {
        return (
          <div className="h-screen w-full bg-slate-950 flex flex-col items-center justify-center text-slate-500">
            <div className="animate-spin mb-3 text-blue-500"><Icon name="loader-2" size={32} /></div>
            <p className="text-sm font-medium">連線中...</p>
          </div>
        );
      }

      // 大廳
      if (currentView === 'accounts') {
        return (
          <div className="h-screen w-full bg-slate-950 text-white flex flex-col max-w-md mx-auto animate-fade-in relative">
            <div className="flex justify-between items-center px-6 py-6 pt-10">
              <div onClick={() => setShowSettings(!showSettings)}>
                <h1 className="text-2xl font-black italic tracking-tighter">MLB 9Innings</h1>
                <p className="text-blue-500 text-[10px] font-bold tracking-[0.2em] uppercase mt-1">Cloud Hub</p>
              </div>
              <button onClick={() => setIsAccountModalOpen(true)} className="bg-blue-600 p-3 rounded-full shadow-lg active:scale-95 transition-all">
                <Icon name="plus" className="text-white" size={24} />
              </button>
            </div>

            {showSettings && (
               <div className="px-6 mb-4 animate-fade-in">
                 <button onClick={handleResetConfig} className="text-xs text-red-400 hover:text-red-300 underline">重設資料庫連結</button>
               </div>
            )}

            <div className="flex-1 overflow-y-auto no-scrollbar px-6 pb-20 space-y-4">
              {accounts.map(acc => (
                <div key={acc.id} onClick={() => { setSelectedAccount(acc); setCurrentView('dashboard'); }} className="group bg-slate-900 border-l-4 border-blue-500 rounded-xl p-5 relative overflow-hidden active:bg-slate-800 transition-all cursor-pointer shadow-md">
                  <div className="absolute right-[-10px] top-[-10px] opacity-5 rotate-12 transition-transform group-hover:rotate-0"><Icon name="trophy" size={100} /></div>
                  <div className="flex justify-between items-start relative z-10">
                    <div>
                      <h3 className="text-xl font-bold mb-1 text-slate-100">{acc.name}</h3>
                      <div className="flex items-center text-slate-400 text-xs font-medium">
                        <span className="mr-1.5"><Icon name="calendar" size={12} /></span>
                        SINCE: <span className="ml-1 text-slate-300">{acc.since}</span>
                      </div>
                    </div>
                    <button onClick={(e) => handleDeleteAccount(e, acc.id)} className="text-slate-600 p-2 -mr-2 -mt-2 active:text-red-400 hover:bg-slate-800 rounded-full"><Icon name="trash-2" size={16} /></button>
                  </div>
                </div>
              ))}
              {accounts.length === 0 && <div className="text-center py-16 opacity-30 text-slate-500">尚無球隊紀錄</div>}
            </div>

            {isAccountModalOpen && (
              <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
                <div className="bg-slate-900 border border-slate-700 w-full max-w-xs rounded-2xl p-6 shadow-2xl animate-slide-up">
                  <h3 className="text-lg font-bold mb-6 text-white flex items-center gap-2"><Icon name="plus-circle" size={20} className="text-blue-500" /> 建立新球隊</h3>
                  <form onSubmit={handleCreateAccount} className="space-y-4">
                    <input type="text" placeholder="球隊名稱" className="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white mt-1" value={newAccountName} onChange={e => setNewAccountName(e.target.value)} required autoFocus />
                    <input type="date" className="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white mt-1" value={newAccountSince} onChange={e => setNewAccountSince(e.target.value)} />
                    <div className="flex gap-3 pt-4">
                      <button type="button" onClick={() => setIsAccountModalOpen(false)} className="flex-1 py-3 text-slate-400">取消</button>
                      <button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">建立</button>
                    </div>
                  </form>
                </div>
              </div>
            )}
          </div>
        );
      }

      // 儀表板
      return (
        <div className="h-screen w-full bg-slate-950 text-white flex flex-col max-w-md mx-auto relative animate-fade-in">
          <div className="sticky top-0 bg-slate-950/80 backdrop-blur-md border-b border-slate-800 p-4 flex items-center gap-3 z-30 pt-safe-top">
            <button onClick={() => { setSelectedAccount(null); setCurrentView('accounts'); }} className="text-slate-400 p-1 hover:text-white -ml-2"><Icon name="chevron-left" size={28} /></button>
            <div className="flex-1 min-w-0">
              <h1 className="text-lg font-bold truncate">{selectedAccount.name}</h1>
              <p className="text-[10px] text-slate-500 font-mono">SINCE {selectedAccount.since}</p>
            </div>
            <div className="text-right bg-slate-900/50 px-3 py-1 rounded-lg border border-slate-800/50">
              <span className="text-[10px] text-slate-500 block uppercase font-bold tracking-wider">Total</span>
              <span className="font-mono font-bold text-lg text-white">{stats.total}</span>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 space-y-6">
            <div className="grid grid-cols-3 gap-3">
              <div className="bg-green-500/10 border border-green-500/20 rounded-2xl p-3 flex flex-col items-center">
                <span className="text-3xl font-black text-green-400 my-1">{stats.signature}</span>
                <span className="text-[9px] uppercase tracking-widest text-green-200/50 font-bold">SIG</span>
              </div>
              <div className="bg-purple-500/10 border border-purple-500/20 rounded-2xl p-3 flex flex-col items-center">
                <span className="text-3xl font-black text-purple-400 my-1">{stats.legend}</span>
                <span className="text-[9px] uppercase tracking-widest text-purple-200/50 font-bold">LEG</span>
              </div>
              <div className="bg-red-500/10 border border-red-500/20 rounded-2xl p-3 flex flex-col items-center">
                <span className="text-3xl font-black text-red-400 my-1">{stats.supreme}</span>
                <span className="text-[9px] uppercase tracking-widest text-red-200/50 font-bold">SUP</span>
              </div>
            </div>

            <div>
              <div className="flex items-center justify-between mb-4 px-1">
                <h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2"><Icon name="layers" size={14} /> Records</h2>
                <button onClick={() => setIsCardModalOpen(true)} className="flex items-center gap-1.5 text-xs bg-blue-600 text-white px-4 py-2 rounded-full font-bold shadow-lg hover:bg-blue-500"><Icon name="plus" size={14} strokeWidth={3} /> ADD</button>
              </div>

              <div className="space-y-3">
                {accountCards.map(card => {
                  const type = getCardTypeInfo(card.type);
                  return (
                    <div key={card.id} className={`group flex items-center gap-4 bg-slate-900/80 p-4 rounded-2xl border-l-4 ${type.border.replace('/50','').replace('/30','')} shadow-sm backdrop-blur-sm transition-all hover:bg-slate-900`}>
                      <div className={`w-10 h-10 rounded-xl flex items-center justify-center shrink-0 ${type.bg} border border-white/5`}><Icon name={type.icon} className={type.color} size={20} /></div>
                      <div className="flex-1 min-w-0">
                        <div className="flex justify-between items-start"><h3 className="font-bold truncate text-base text-slate-100">{card.name}</h3></div>
                        <div className="flex items-center gap-2 mt-1.5">
                          <span className={`text-[10px] px-2 py-0.5 rounded-md font-bold tracking-wide ${type.bg} ${type.color} border border-white/5`}>{type.label.split(' ')[0]}</span>
                          <span className="text-[10px] text-slate-500 font-mono mt-0.5">{card.date}</span>
                        </div>
                      </div>
                      <button onClick={() => handleDeleteCard(card.id)} className="p-2 text-slate-600 opacity-50 group-hover:opacity-100 hover:text-red-400 active:scale-90 transition-all"><Icon name="trash-2" size={18} /></button>
                    </div>
                  );
                })}
                {accountCards.length === 0 && <div className="text-center py-12 opacity-30 text-sm">尚無紀錄</div>}
              </div>
            </div>
          </div>

          {isCardModalOpen && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-end justify-center sm:items-center">
              <div className="bg-slate-900 border-t sm:border border-slate-700 w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 animate-slide-up shadow-2xl pb-10 sm:pb-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className="text-xl font-bold text-white flex items-center gap-2"><Icon name="sparkles" size={20} className="text-yellow-500" /> 新增紀錄</h3>
                  <button onClick={() => setIsCardModalOpen(false)} className="text-slate-500 bg-slate-800 p-2 rounded-full hover:text-white"><Icon name="x" size={20} /></button>
                </div>
                <form onSubmit={handleAddCard} className="space-y-5">
                  <div>
                    <label className="text-xs text-slate-400 font-bold uppercase tracking-wider ml-1">球員名稱 / 年份</label>
                    <input type="text" placeholder="例如: Ohtani '24" className="w-full bg-slate-800 border border-slate-700 p-4 rounded-xl text-white mt-1.5 text-lg font-medium" value={newCardName} onChange={e => setNewCardName(e.target.value)} required autoFocus />
                  </div>
                  <div>
                    <label className="text-xs text-slate-400 font-bold uppercase tracking-wider ml-1">卡片種類</label>
                    <div className="grid grid-cols-3 gap-2 mt-1.5">
                      {CARD_TYPES.map(type => (
                        <button key={type.id} type="button" onClick={() => setNewCardType(type.id)} className={`text-[10px] py-3 px-1 rounded-xl border transition-all flex flex-col items-center gap-1.5 ${newCardType === type.id ? `${type.color} ${type.border} bg-slate-800 ring-2 ring-current font-bold shadow-lg` : 'text-slate-500 border-slate-800 bg-slate-800/50 hover:bg-slate-800'}`}>
                          <Icon name={type.icon} size={16} />{type.label.split(' ')[0]}
                        </button>
                      ))}
                    </div>
                  </div>
                  <div>
                    <label className="text-xs text-slate-400 font-bold uppercase tracking-wider ml-1">獲得日期</label>
                    <input type="date" className="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white mt-1.5" value={newCardDate} onChange={e => setNewCardDate(e.target.value)} />
                  </div>
                  <button type="submit" className="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white rounded-xl font-bold text-lg mt-2">儲存紀錄</button>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
